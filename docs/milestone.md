# 改进需求与开发规划
本次改进目标使冥王星可以真正的被用户使用起来，至少满足本团队成员日常生活中涉及到的日历、任务和备忘的需求。

## 改进需求
针对目前冥王星的功能以及概念定义上的改进

1. 日历、任务和备忘的概念定义

    目前版本的冥王星只定义了日程的概念，体现在用户新创建的日程，以及从系统日历下载的日历内容都存储在日程表中，没有进行区分。

    以下是本次改进对日历、任务和备忘的定义

    |     | 日历<sup>[1](#note-calendar-object)</sup> | 日程<sup>[2](#note-task-object)</sup> | 任务<sup>[2](#note-task-object)</sup> | 小任务<sup>[2](#note-task-object)</sup> | 备忘事<sup>[3](#note-memo-object)</sup> | 备忘信息<sup>[3](#note-memo-object)</sup> |
    | --- | :----: | :----: | :----: | :----: | :----: | :----: |
    | 提醒 | 是 | 是 | 是 | 是 | 无 | 无 |
    | 事后提醒 | 否 | 否 | 是 | 否 | 无 | 无 |
    | 要求确认 | 否 | 是 | 是 | 否 | ~~是<sup>[Q1](#note-question-1)</sup>~~无 | 无 |
    | 时间维度 | 开始 | 开始 | 开始+结束 | 无 | 当前时间 | 无 |
    | 状态 | 无 | 时间过后无 | 结束后无 | 提醒过后无 | 无 | 无 |
    | 分享 | 是 | 是 | 是 | 无 | 无<sup>[Q4](#note-question-4)</sup> | 无<sup>[Q4](#note-question-4)</sup> |
    | 邀请 | 无 | 是 | 是 | 无 | 无 | 无 |
    | 具体信息 | 无 | 有 | 有 | 无 | 无 | 无 |

    <a name="note-calendar-object">1. 日历</a>: 具备日期、名称的对象为日历对象，例如：农历节气中的"2019年7月23日 大暑"是日历对象，日历由多个对象组成，并赋予名称

    <a name="note-task-object">2. 任务</a>: 任务分为日程、任务和小任务

    <a name="note-memo-object">3. 备忘</a>: 备忘分为事和信息，例如：通过语音记录的借钱/还钱记录到备忘事中，不同日期的多次记录保存到同一条备忘中

2. 通知与提醒

    由于手机厂商对安卓系统定制深度不同，导致应用在被关闭之后，本地的提醒无法准时提醒用户，现对通知和提醒做以下定义和实现方案

    1. 通知和提醒的概念定义

    *通知* 为无精确时效要求的信息传达，用户可以在发生前或者发生后再收到; *提醒* 为有精确时效要求的信息传达，用户只有在发生时收到。

    以下是冥王星中信息传达的具体分类

    | | 通知 | 提醒 |
    |-|:----:|:---:|
    |智能提醒 每日简报| 通知 | - |
    |智能提醒 极端气候警报| 通知 | - |
    |日历 生日提醒<sup>[Q5](#note-question-5)</sup>| 通知 | - |
    |日历 结婚纪念日提醒| 通知 | - |
    |日历 世界杯小组赛 A组 第一场比赛提醒| 通知 | - |
    |日程 接收邀请通知| 通知 | - |
    |日程 提前10分钟提醒| - | 提醒 |
    |任务 接收邀请通知| 通知 | - |
    |任务 提前10分钟提醒| - | 提醒 |
    |任务 事后提醒| 通知 | - |
    |小任务 提前10分钟提醒| - | 提醒 |

    2. 正常过程 *一方或关联多方在事件发生时冥王星处于联机状态*

    用户B在接收到邀请后, 接受了邀请

    | | 时间线 | 用户A | 用户B | 处理逻辑 |
    |-|:-:|:---:|:---:|:-|
    |1|第一天 上午|创建日程 __*明天下午三点开项目总结会*__| |用户A本地+服务器端保存|
    |2|第一天 上午|设置 __*提前10分钟提醒*__| |用户A本地+服务器端保存|
    |3|第一天 上午|邀请 __*用户B*__ 参加| |用户A本地+服务器端保存, 发送通知和透传消息给用户B|
    |4|第一天 上午/下午||收到 __*用户A*__ __*明天下午三点开项目总结会*__ 通知|收到通知显示在系统通知栏上, <br/>收到透传消息缓存日程到用户B本地|
    |5|第一天 上午/下午||接受邀请|用户B本地+服务器端保存|
    |6|第二天 上午|追加设置 __*提前30分钟提醒*__||用户A本地+服务器端保存, <br/>发送透传消息给用户B, <br/>用户B收到消息后, 用户B本地+服务器端保存|
    |7|第二天 下午两点半|收到 __*下午三点开项目总结会通知+提醒*__|收到 __*下午三点开项目总结会通知+提醒*__|服务端发送通知和透传消息给用户A和用户B<br/>(1分钟内接收有效), <br/>两个客户端收到通知显示在系统通知栏上, <br/>收到透传消息自动进行语音播报, <br/>用户点击通知栏中的通知, 打开对应的日程画面|
    |8|第二天 下午两点五十分|收到 __*下午三点开项目总结会通知+提醒*__|收到 __*下午三点开项目总结会通知+提醒*__|同上|

    用户B在接收到邀请后, 拒绝了邀请

    | | 时间线 | 用户A | 用户B | 处理逻辑 |
    |-|:-:|:---:|:---:|:-|
    |1|第一天 上午|创建日程 __*明天下午三点开项目总结会*__| |用户A本地+服务器端保存|
    |2|第一天 上午|设置 __*提前10分钟提醒*__| |用户A本地+服务器端保存|
    |3|第一天 上午|邀请 __*用户B*__ 参加| |用户A本地+服务器端保存, 发送通知和透传消息给用户B|
    |4|第一天 上午/下午||收到 __*用户A*__ __*明天下午三点开项目总结会*__ 通知|收到通知显示在系统通知栏上, <br/>收到透传消息缓存日程到用户B本地|
    |5|第一天 上午/下午||拒绝邀请|用户B本地删除缓存|
    |6|第二天 上午|追加设置 __*提前30分钟提醒*__||用户A本地+服务器端保存 ~~, <br/>发送透传消息给用户B, <br/>用户B收到消息后, 用户B本地+服务器端保存~~|
    |7|第二天 下午两点半|收到 __*下午三点开项目总结会通知+提醒*__|~~收到 __*下午三点开项目总结会通知+提醒*__~~|服务端发送通知和透传消息给用户A ~~和用户B~~<br/>(1分钟内接收有效), <br/>用户A客户端收到通知显示在系统通知栏上, <br/>收到透传消息自动进行语音播报, <br/>用户点击通知栏中的通知, 打开对应的日程画面|
    |8|第二天 下午两点五十分|收到 __*下午三点开项目总结会通知+提醒*__|~~收到 __*下午三点开项目总结会通知+提醒*__~~|同上|

    3. 异常过程 *一方或关联多方在部分事件发生时冥王星处于离线状态*

    用户B在第二天冥王星一直处于离线状态, 直到第三天上午才上线, 手机处于开机状态

    | | 时间线 | 用户A | 用户B | 处理逻辑 |
    |-|:-:|:---:|:---:|:-|
    |1|第一天 上午|创建日程 __*明天下午三点开项目总结会*__| |用户A本地+服务器端保存|
    |2|第一天 上午|设置 __*提前10分钟提醒*__| |用户A本地+服务器端保存|
    |3|第一天 上午|邀请 __*用户B*__ 参加| |用户A本地+服务器端保存, 发送通知和透传消息给用户B|
    |4|第一天 上午/下午||收到 __*用户A*__ __*明天下午三点开项目总结会*__ 通知|收到通知显示在系统通知栏上, <br/>收到透传消息缓存日程到用户B本地|
    |5|第一天 上午/下午||接受邀请|用户B本地+服务器端保存|
    |6*|第二天 上午|追加设置 __*提前30分钟提醒*__||用户A本地+服务器端保存, <br/>发送透传消息给用户B ~~, <br/>用户B收到消息后, 用户B本地+服务器端保存~~<br/>(该透传消息到下午两点半前有效)|
    |7*|第二天 下午两点半|收到 __*下午三点开项目总结会通知+提醒*__|收到 __*下午三点开项目总结会通知+提醒*__|服务端发送通知和透传消息给用户A和用户B<br/>(1分钟内接收有效), <br/>两个客户端收到通知显示在系统通知栏上, <br/>用户A收到透传消息自动进行语音播报, <br/>用户B没有自动语音播报,<br/>用户A点击通知栏中的通知, 打开对应的日程画面,<br/>用户B没有打开通知|
    |8*|第二天 下午两点五十分|收到 __*下午三点开项目总结会通知+提醒*__|收到 __*下午三点开项目总结会通知+提醒*__|同上|
    |9*|第三天||打开冥王星, 并打开昨天 __*开项目总结会*__ 日程|日历首页不显示新消息提醒(红点), 日程页面不显示任何提醒设置项|

    用户B从第一天开始冥王星一直处于离线状态, 直到第三天上午才上线, 手机处于开机状态

    | | 时间线 | 用户A | 用户B | 处理逻辑 |
    |-|:-:|:---:|:---:|:-|
    |1|第一天 上午|创建日程 __*明天下午三点开项目总结会*__| |用户A本地+服务器端保存|
    |2|第一天 上午|设置 __*提前10分钟提醒*__| |用户A本地+服务器端保存|
    |3|第一天 上午|邀请 __*用户B*__ 参加| |用户A本地+服务器端保存, 发送通知和透传消息给用户B|
    |4|第一天 上午/下午||收到 __*用户A*__ __*明天下午三点开项目总结会*__ 通知|收到通知显示在系统通知栏上 ~~, <br/>收到透传消息缓存日程到用户B本地~~|
    |5|第一天 上午/下午||~~接受邀请~~|~~用户B本地+服务器端保存~~|
    |6*|第二天 上午|追加设置 __*提前30分钟提醒*__||用户A本地+服务器端保存 ~~, <br/>发送透传消息给用户B, <br/>用户B收到消息后, 用户B本地+服务器端保存<br/>(该透传消息到下午两点半前有效)~~|
    |7*|第二天 下午两点半|收到 __*下午三点开项目总结会通知+提醒*__|~~收到 __*下午三点开项目总结会通知+提醒*__~~|服务端发送通知和透传消息给用户A~~和用户B~~<br/>(1分钟内接收有效), <br/>用户A客户端收到通知显示在系统通知栏上, <br/>用户A收到透传消息自动进行语音播报, <br/>~~用户B没有自动语音播报,<br/>~~用户A点击通知栏中的通知, 打开对应的日程画面~~,<br/>用户B没有打开通知~~|
    |8*|第二天 下午两点五十分|收到 __*下午三点开项目总结会通知+提醒*__|~~收到 __*下午三点开项目总结会通知+提醒*__~~|同上|
    |9*|第三天||打开冥王星<sup>[Q2](#note-question-2)</sup> ~~, 并打开昨天 __*开项目总结会*__ 日程~~|~~日历首页不显示新消息提醒(红点), 日程页面不显示任何提醒设置项~~|

3. 邀请

    现有 *__发送__* 日程概念, 使用 *__邀请__* 概念替代, 邀请将支持两种模式, 一种即原有模式, 通过添加联系人方式邀请; 另外新增一种通过发送邀请页面, 由参与者通过邀请页面接受邀请。<br/>
    邀请将支持两种__权限__, 一种即原有权限限制, 只有发起人可以修改日程内容, 并同步到所有参与人对应日程中, 下文称为"私有邀请/私有邀请日程"; 另外新增一种所有参与人都可以修改日程内容, 并同步到所有参与人对应日程中, 下文成为"公开邀请/公开邀请日程"。<br/>
    邀请权限可以在邀请发起时选择, 默认为私有邀请。

    __再邀请__, 私有邀请日程只有发起人可以再邀请; 公开邀请日程任何人都可以再邀请[Q3](#note-question-3)</sup>。<br/>
    __不保留日程__, 日程在邀请时, 可以选择不保留日程(即:一旦邀请成功, 发起人本地日程将自动删除, 发起人也将从日程参与人中移除), 默认为保留日程。

    邀请人未接受邀请前, 都视为不接受/拒绝。<br/>
    邀请状态: 未发送、未送达、送达、接受、拒绝

    以下是邀请的处理逻辑

    1. 邀请

    通过添加联系人共享日程

    | | 用户A | 用户B | 处理逻辑 |
    |-|:---:|:---:|:---|
    |1|日程 __*7月28日 托福考试 考点宁波*__ <br/>页面选择邀请, 进入邀请页面, <br/>选择默认权限(私有), 保留日程, 选择下一步, <br/>进入联系人选择页面, 选择受邀人用户B, 选择确定||用户A本地+服务器端保存<br/>本地受邀人状态"未送达"<br/>服务器端发送通知和透传消息给用户B|
    |2||收到 __*用户A*__ __*7月28日 托福考试 考点宁波*__ 通知|收到通知显示在系统通知栏上, <br/>收到透传消息缓存日程到用户B本地|
    |3||打开消息, 显示日程页面, 并弹出"邀请确认", 选择"接受"|加载缓存日程, 显示日程, <br/>弹出"邀请确认"确认框;<br/>接受: 用户B本地+服务器端保存<br/>服务器端设置原日程对应受邀人"用户B"状态"接受"<br/>发送透传消息给用户A|
    |4|||收到透传消息更新对应日程受邀人"用户B"状态"接受"|

    2. 页面邀请

    通过分享邀请页面, 受邀人主动获取并加入共享日程

    | | 用户A | 用户B | 处理逻辑 |
    |-|:---:|:---:|:---|
    |1|日程 __*7月28日 托福考试 考点宁波*__ <br/>页面选择页面邀请, 进入邀请页面, <br/>选择权限公开, 保留日程, 选择下一步, 分享到微信联系人||用户A本地+服务器端保存<br/>无受邀人|
    |2||打开微信分享链接, 点击 __*\"在冥王星打开\"*__ 按钮, <br/>冥王星启动, 显示日程页面, <br/>并弹出"邀请确认", 选择"接受"|微信分享页面根据打开用户的手机类型, <br/>使用iOS或者Android的应用跳转链接, <br/>并附带日程ID参数。<br/>冥王星启动后, 根据日程ID请求服务器获取日程信息, 缓存到用户B本地, <br/>加载缓存日程, 显示日程, <br/>弹出"邀请确认"确认框;<br/>接受: 用户B本地+服务器端保存<br/>服务器端设置原日程新增受邀人"用户B"状态"接受"<br/>发送透传消息给用户A|
    |3|||收到透传消息更新对应日程新增受邀人"用户B"状态"接受"|

4. 分享

    新增日程第三方软件分享功能, 用于满足个人展示需求。<br/>
    分享不限于自己创建的日程, 受邀请的日程也可以进行分享。<br/>
    已分享的日程修改之后, 修改内容不反映到修改前分享的页面中, 重新分享将生成新的分享链接。

5. 技术难点

    现有版本用户使用过程中发现, 冥王星在不运行(即用户在手机打开应用中看不到冥王星)的状态下, 无法及时收到通知, 打开冥王星之后, 一下子收到很多通知; 语音在使用过程中不稳定, 具体表现在说过一句话之后要很久(超过5秒)才有回复, 或者干脆没有, 重新打开冥王星之后, 之前的语音回复又来了。

    1. 通知及时性

        经过调研, 使用极光推送(通过其它使用极光推送的app拉起冥王星进程, 达到离线接收通知的效果)可以在部分情况下, 冥王星不运行的状态下, 用户手机可以收到通知, 但是不能确保任何时候可以收到;<br/>
        而极光推送集成的iOS设备的通知, 最终使用苹果公司的通知服务实现通知, 理论上可以达到任何时候可以收到的效果, 需要在真机环境下验证;

        为了使Android手机达到我们需要的效果, 需要集成多个手机厂商的推送服务, 目前考虑集成小米PUSH和华为推送服务, 小米PUSH还需要在真机环境下验证, 华为推送已经验证有效。

    2. 语音响应速度与稳定性

      目前实现方式是使用 __*百度语音*__ 进行语音听写, 并获得用户输入的音频文件, 上传 __*阿里云*__ 服务器, 阿里云服务器端调用讯飞AIUI接口, 获得讯飞语义解析结果, 然后调用 __*效吉软件*__ 公司服务器端不同的语义解析逻辑转换成客户端可识别的冥王星协议, 通过RabbitMQ发送给客户端。

      响应速度:
          1. 天气查询, 大部分响应在1.5秒以内, 个别情况超过5秒或者无响应。
          2. 日程查询, 大部分响应在1.5秒以内, 个别情况超过5秒或者无响应。

      问题判断:
          1. 语音消息和日程共享等共用同一个消息队列, 消息队列客户端执行消息按照顺序执行, 个别情况超过5秒可能是因为语音消息排在其它消息之后, 目前天气信息是通过消息队列每5分钟推送一次, 重新打开冥王星后, 消息队列中积压的消息会一下子推送到客户端, 导致语音消息被延后执行;
          2. 还有一种情况是, 客户端网络切换后, RabbitMQ还没有检测到客户端断开, 客户端重新连接后, RabbitMQ会产生两个客户端连接到同一个消息队列, 导致RabbitMQ推送的消息被推送到已经断开的客户端连街上, 导致新的连接无法收到该消息;
          3. 另外一种情况是, 客户端Sqlite查询效率低, 当用户创建了较多重复日程, 日程查询较慢, 根据实际测试较少日程的情况下查询时间在60毫秒左右, 当有较多重复日程的情况下查询时间一下子跳升到700毫秒以上。

      解决方案:
          1. 语音消息和其它消息分别通过不同的消息队列接收和处理, 互相不影响
          2. 网络断开重新连接后, 创建新的消息队列接收消息, 存在的问题是新的消息队列无法背压, 存储离线状态下未接收的消息, 语音消息不需要背压, 网络重连可以通知用户网络异常, 让用户知道因为网络问题冥王星无法处理他的语音请求。
          3. 优化客户端Sqlite查询效率, 或者使用缓存提高语音相应速度
          4. 使用讯飞语音听写接口, 可以省略语音上传过程, 缺点是讯飞将直接把语义解析结果返回给客户端, 语义解析后处理将只能由客户端自己完成。


## 问题
<a name="note-question-1">1. 备忘事不能被邀请，怎么会有确认？</a>

~~待确认~~ 备忘不能推送(即邀请他人共享)给他人, 所以不存在确认

<a name="note-question-2">2. 如果第4步接收到的通知仍然存在于系统通知栏上, 这个时候用户再去点开通知, 页面应该如何显示？</a>

显示日程内容, 弹出已过期? 还是直接就进入日历画面, 不进入对应的日程画面(因为还没有选择是否接受, 而且这个日程已经过期)?

<a name="note-question-3">3. 这个和未来可能的应用场景"公开活动日程"不符</a>

这种场景下, 日程内容只能由发起者修改, 但是, 参与者可以自由再邀请。

<a name="note-question-4">4. 备忘内容有需求把内容发送给他人的需求</a>

备忘的备忘内容不能分享，无法满足把内容发送给他人的需求。<br/>
例如：我备忘的阿里云密码内容，需要的时候，需要发送给你。

<a name="note-question-5">5. 类似生日提醒的日历项, 用户有增加提醒时间的需求, 需要准时送达</a>

用户增加的提醒时间行为视作小任务。<br/>
在日历项相关显示页面增加添加提醒功能, 添加的提醒存储为小任务, 后续的提醒按照小任务提醒流程处理。

## 参考资料

### 19年7月 改进需求讨论记录一 *2019年7月17日* *张金洋* *席理加*

1. 图片记录

![改进需求讨论记录 9-1](images/milestone2/milestone2_1.jpg)

![改进需求讨论记录 9-2](images/milestone2/milestone2_2.jpg)

![改进需求讨论记录 9-3](images/milestone2/milestone2_3.jpg)

![改进需求讨论记录 9-4](images/milestone2/milestone2_4.jpg)

![改进需求讨论记录 9-5](images/milestone2/milestone2_5.jpg)

![改进需求讨论记录 9-6](images/milestone2/milestone2_6.jpg)

![改进需求讨论记录 9-7](images/milestone2/milestone2_7.jpg)

![改进需求讨论记录 9-8](images/milestone2/milestone2_8.jpg)

2. 补充说明

类似借钱这样的事情记录在备忘里面，记录在同一条记录里面，而不要显示在日程里面<br/>
*(实现不能使用任务相关数据库表保存备忘记录)*

过去的日程，不能共享，不显示提醒，可以创建
任务只能创建未来的时间或者不指定时间

单独给别人的任务或日程，只提醒对方，画面可以选择只提醒对方或者也提醒自己
只让对方看到

分享和邀请，不考虑公开和私有，共享一个连接，点开后都能加入，不能再分享。
邀请时可选只有自己修改，所有人都可以修改，自己是否保留日程。
只有自己修改，别人不能再邀请，都有人都可以修改，别人都可以邀请。
不保留日程，只能选择都有人都可以修改

只有自己修改的模式不能改成所有人都可以修改，反之亦然
需要改变模式，重新创建
