branches:
  only:
  - develop
  - cassiscornuta
matrix:
  include:
  - os: linux
    sudo: true
    name: unittest
    language: node_js
    dist: trusty
    node_js:
      - 8
    addons:
      apt:
        update: true
        sources:
        - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
          key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
        - sourceline: deb https://dl.google.com/linux/deb/ stable main
          key_url: https://dl.google.com/linux/linux_signing_key.pub
        - google-chrome
        - rabbitmq-trusty
        packages:
          - yarn
          - jq
          - gradle
          - sshpass
          - dos2unix
    licenses:
      - google-gdk-license-.+
    cache:
      npm: false
  - os: linux
    sudo: true
    name: androidpackage
    language: android
    dist: trusty
    android:
      components:
      - platform-tools
      - tools
      - build-tools-26.0.2
      - android-27
      - extra-google-google_play_services
      - extra-google-m2repository
      - extra-android-m2repository
    addons:
      apt:
        update: true
        sources:
        - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
          key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
        - sourceline: deb https://dl.google.com/linux/deb/ stable main
          key_url: https://dl.google.com/linux/linux_signing_key.pub
        - google-chrome
        - rabbitmq-trusty
        packages:
          - yarn
          - jq
          - gradle
          - sshpass
          - dos2unix
    licenses:
      - android-sdk-preview-license-.+
      - android-sdk-license-.+
      - google-gdk-license-.+
  - os: osx
    name: iospackage
    language: objective-c
    osx_image: xcode10.2
    addons:
      homebrew:
        packages:
        - dos2unix
        - carthage
        casks:
        - github
      chrome: beta
    cache:
      directories:
      - "$HOME/build/leonxi/largefiles/"
  allow_failures:
    - os: osx
#before_cache:
#  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
#  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
#  - rm -rf $HOME/.gradle/caches/3.5/fileHashes/
#  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/
#cache:
#  directories:
#  - "$HOME/build/leonxi/largefiles/"
#  - "$HOME/.gradle/caches/"
#  - "$HOME/.gradle/wrapper/"
#  - "$HOME/Library/Caches/Yarn/v1/"
#  - "$HOME/.cache/yarn/v1/"
before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get -yq install fonts-liberation libappindicator3-1 xdg-utils ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget http://dl.google.com/linux/deb/pool/main/g/google-chrome-stable/google-chrome-stable_76.0.3809.132-1_amd64.deb ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo dpkg -i google-chrome-stable_76.0.3809.132-1_amd64.deb ; fi
  - export LANG=zh_CN.UTF-8
  - export GRADLE_HOME=/usr/local/gradle
  - export PATH=$GRADLE_HOME/bin:$PATH
  - export SSHPASS=$ALIYUN_PASS
  - if [[ "$TRAVIS_JOB_NAME" != "unittest" ]]; then nvm install 8 ; fi
  - dos2unix -k $TRAVIS_BUILD_DIR/travis/preinstall.sh
  - sh $TRAVIS_BUILD_DIR/travis/preinstall.sh
  - gem install byebug
  - if [[ "$TRAVIS_JOB_NAME" != "unittest" ]]; then gem install fir-cli ; fi
  - cp $TRAVIS_BUILD_DIR/config/build.gradle $TRAVIS_BUILD_DIR/TimeApp/build.gradle
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sed -i 's/905/'$TRAVIS_BUILD_NUMBER'/g' $TRAVIS_BUILD_DIR/TimeApp/config.xml ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sed -i '' 's/22/'$TRAVIS_BUILD_NUMBER'/g' $TRAVIS_BUILD_DIR/TimeApp/config.xml ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sed -i '' 's/1\.9\.3/'1\.1\.3'/g' $TRAVIS_BUILD_DIR/TimeApp/config.xml ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sed -i '' 's/15/'$TRAVIS_BUILD_NUMBER'/g' $TRAVIS_BUILD_DIR/TimeAppPatch/info.plist ; fi
  - cd TimeApp
install:
  - if [[ "$TRAVIS_JOB_NAME" == "unittest" ]]; then rm -rf package-lock.json ; fi
before_script:
  - pwd
  - ionic cordova plugin add $TRAVIS_BUILD_DIR/BaiduSpeechAndTTS
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then ionic cordova plugin add $TRAVIS_BUILD_DIR/HuaweiPushPlugin --save ; fi
  - if [[ "$TRAVIS_OS_NAME" == "none" ]]; then ionic cordova plugin add cordova-plugin-crosswalk-webview ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then ionic cordova plugin add cordova-plugin-swift-support ; fi
  - ionic cordova plugin add cordova-plugin-app-version cordova-sqlite-storage cordova-plugin-camera@4.0.3 cordova-plugin-chooser cordova-plugin-statusbar uk.co.workingedge.cordova.plugin.sqliteporter cordova-sqlite-storage cordova-plugin-whitelist com.telerik.plugins.nativepagetransitions cordova-plugin-nativeaudio cordova-plugin-vibration cordova-plugin-file-transfer cordova-plugin-local-notification cordova-plugin-ionic-webview cordova-plugin-splashscreen ionic-plugin-keyboard cordova-plugin-device cordova-plugin-console cordova-plugin-file cordova-plugin-filechooser cordova-plugin-filepath cordova-plugin-file-opener2 cordova-plugin-calendar cordova-plugin-advanced-http cordova-plugin-android-permissions cordova-plugin-background-mode cordova-plugin-contacts cordova-clipboard cordova-plugin-network-information cordova-plugin-screen-orientation
  - ionic cordova plugin add https://github.com/apache/cordova-plugin-network-information#master --force
  - ionic cordova plugin add https://github.com/xiaoji-duan/jpush-phonegap-plugin.git --variable APP_KEY=$JPUSH_API_KEY
  - ionic cordova plugin add https://github.com/xiaoji-duan/cordova-plugin-rabbitmq.git
  - ionic cordova plugin add cordova-plugin-geolocation --variable GEOLOCATION_USAGE_DESCRIPTION="定位以获得更准确的天气预报"
  - ionic cordova plugin add cordova-plugin-wechat --variable wechatappid=$WEIXIN_APPID
  - ionic cordova plugin add cordova-plugin-telerik-imagepicker --variable PHOTO_LIBRARY_USAGE_DESCRIPTION="拍照上传活动补充"
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then cp $HOME/build/leonxi/largefiles/cordova/plugins/baidutts/ios/libBaiduTTSSDK.a ./plugins/cordova-plugin-BaiduSpeechAndTTS/src/ios/BDSClientLib/libBaiduTTSSDK.a ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then cp $HOME/build/leonxi/largefiles/cordova/plugins/baidutts/ios/libBaiduASRSDK.a ./plugins/cordova-plugin-BaiduSpeechAndTTS/src/ios/BDSClientLib/libBaiduASRSDK.a ; fi
  - cp -rf ../TimeAppPatch/plugins/* ./plugins
  - dos2unix -k $TRAVIS_BUILD_DIR/travis/add-keys.sh
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sh $TRAVIS_BUILD_DIR/travis/add-keys.sh ; fi
script:
  - ionic cordova plugin ls
  - yarn install
  - rm -f $TRAVIS_BUILD_DIR/TimeApp/node_modules/swiper/js/swiper.esm.*
  - ls $TRAVIS_BUILD_DIR/TimeApp/node_modules/swiper/js/
  - npm run clean
  - npm run build
  - if [[ "$TRAVIS_JOB_NAME" == "unittest" ]]; then npm run test-coverage ; fi
  - if [[ "$TRAVIS_JOB_NAME" == "unittest" ]]; then dos2unix -k $TRAVIS_BUILD_DIR/travis/upload-coverage.sh ; fi
  - if [[ "$TRAVIS_JOB_NAME" == "unittest" ]]; then sh $TRAVIS_BUILD_DIR/travis/upload-coverage.sh ; fi
  - if [[ "$TRAVIS_JOB_NAME" != "unittest" ]]; then dos2unix -k $TRAVIS_BUILD_DIR/travis/build.sh ; fi
  - if [[ "$TRAVIS_JOB_NAME" != "unittest" ]]; then sh $TRAVIS_BUILD_DIR/travis/build.sh ; fi
after_script:
  - dos2unix -k $TRAVIS_BUILD_DIR/travis/fir.sh
  - dos2unix -k $TRAVIS_BUILD_DIR/travis/remove-keys.sh
  - sh $TRAVIS_BUILD_DIR/travis/fir.sh
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sh $TRAVIS_BUILD_DIR/travis/remove-keys.sh ; fi
env:
  global:
  - LANG=zh_CN.UTF-8
  - JAVA_HOME=/usr/lib/jvm/java-8-oracle
  - IOS_APP_NAME="冥王星"
  - 'IOS_DEVELOPER_NAME="iPhone Developer: Jinyang Zhang (Q696DBG8US)"'
  - IOS_PROFILE_NAME="e3f01904-e6ed-45c4-a7f4-fe91b39e151f"
  - IOS_PROFILE_NAME_FIR="f8c0bffd-651e-40b4-9dcd-06dcb67c6011"
  - FIR_TIMEOUT=500
jdk:
  - oraclejdk8
